{% extends 'base.html' %}

{% block title %}Patient Details{% endblock %}

{% block content %}
<h2><i class="fas fa-user-injured"></i> Patient Details: {{ patient.get_full_name }}</h2>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Patient Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Name:</strong> {{ patient.get_full_name }}</p>
                <p><strong>Email:</strong> {{ patient.email }}</p>
                <p><strong>Phone:</strong> {{ patient.phone }}</p>
                <p><strong>DOB:</strong> {{ patient.date_of_birth|default:"N/A" }}</p>
                <p><strong>Address:</strong> {{ patient.address|default:"N/A" }}</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">

                <!-- THIS IS THE NEW BUTTON I ADDED -->
                <a href="{% url 'doctor:add_medical_history' patient.id %}" class="btn btn-primary btn-sm w-100 mb-2">
                    <i class="fas fa-plus"></i> Add Medical History
                </a>
                <!-- END OF NEW BUTTON -->
                <a href="{% url 'doctor:create_treatment_plan' patient.id %}" class="btn btn-success btn-sm w-100 mb-2">
                    <i class="fas fa-file-medical"></i> Create Treatment Plan
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <ul class="nav nav-tabs" id="patientTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#history">Medical History</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#appointments">Appointments</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#prescriptions">Prescriptions</a>
            </li>
        </ul>
        
        <div class="tab-content p-3 border border-top-0">
            <div class="tab-pane fade show active" id="history">
                {% if medical_history %}
                    {% for history in medical_history %}
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>{{ history.diagnosis }}</h6>
                            <p class="mb-1"><strong>Medications:</strong> {{ history.medications }}</p>
                            <p class="mb-1"><strong>Allergies:</strong> {{ history.allergies|default:"None" }}</p>
                            <p class="mb-1"><strong>Treatment:</strong> {{ history.treatment_history }}</p>
                            <small class="text-muted">Recorded on: {{ history.date_recorded }}</small>
                            {% if history.recorded_by %}
                            <br><small class="text-muted">By: Dr. {{ history.recorded_by.get_full_name }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No medical history available. 
                        <a href="{% url 'doctor:add_medical_history' patient.id %}" class="alert-link">Add one now</a>
                    </div>
                {% endif %}
            </div>
            
            <div class="tab-pane fade" id="appointments">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appointment in appointments %}
                        <tr>
                            <td>{{ appointment.appointment_date }}</td>
                            <td>{{ appointment.appointment_time }}</td>
                            <td><span class="badge bg-info">{{ appointment.status }}</span></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center">No appointments</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="tab-pane fade" id="prescriptions">
                {% if prescriptions %}
                    {% for prescription in prescriptions %}
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>{{ prescription.medication_name }}</h6>
                            <p class="mb-1"><strong>Dosage:</strong> {{ prescription.dosage }}</p>
                            <p class="mb-1"><strong>Frequency:</strong> {{ prescription.frequency }}</p>
                            <p class="mb-1"><strong>Duration:</strong> {{ prescription.duration }}</p>
                            <small class="text-muted">{{ prescription.created_at }}</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No prescriptions available</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}